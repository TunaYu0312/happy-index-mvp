<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¼€å¿ƒæŒ‡æ•°ç¤¾åŒº - åŒ¿åå¿ƒæƒ…åˆ†äº«å¹³å°</title>
<style>
    * { box-sizing: border-box; }
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        max-width: 800px; 
        margin: 0 auto; 
        padding: 20px; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        line-height: 1.6;
    }
    
    .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
    }
    
    h1 { 
        text-align: center; 
        color: #333;
        margin-bottom: 40px;
        font-size: 2.2em;
        font-weight: 300;
    }
    
    .mood-section {
        margin-bottom: 40px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px solid #e9ecef;
    }
    
    .slider-container {
        margin: 30px 0;
        position: relative;
    }
    
    .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .label-left {
        color: #2196F3;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .label-right {
        color: #FF4444;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .slider {
        width: 100%;
        height: 12px;
        border-radius: 6px;
        background: linear-gradient(to right, #2196F3 0%, #4CAF50 50%, #FF4444 100%);
        outline: none;
        -webkit-appearance: none;
        margin: 20px 0;
    }
    
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 3px solid #333;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .slider::-moz-range-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 3px solid #333;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .score-display {
        text-align: center;
        font-size: 2em;
        font-weight: bold;
        margin: 20px 0;
        padding: 15px;
        background: white;
        border-radius: 10px;
        border: 2px solid #ddd;
    }
    
    textarea { 
        width: 100%; 
        height: 100px; 
        margin-top: 15px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        resize: vertical;
        font-family: inherit;
    }
    
    textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button { 
        display: block; 
        margin: 25px auto; 
        padding: 15px 30px; 
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white; 
        border: none; 
        border-radius: 25px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .stats { 
        background: white; 
        padding: 25px; 
        margin-top: 30px; 
        border-radius: 15px;
        border: 2px solid #e9ecef;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .stats h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }
    
    .stats p {
        margin: 15px 0;
        font-size: 16px;
    }
    
    .mood-list { 
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .mood-item {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }
    
    .history-section {
        margin-top: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px solid #e9ecef;
    }
    
    .history-item {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        border-left: 4px solid #28a745;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .clear-btn {
        background: #dc3545;
        padding: 8px 16px;
        font-size: 14px;
        margin: 10px 5px;
    }
    
    .privacy-toggle {
        margin: 15px 0;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 10px;
        border: 2px solid #2196F3;
    }
    
    .privacy-toggle label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .privacy-toggle input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .community-section {
        margin-top: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px solid #e9ecef;
    }
    
    .mood-card {
        background: white;
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .mood-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .mood-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .mood-score {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
    }
    
    .mood-time {
        color: #666;
        font-size: 0.9em;
    }
    
    .mood-content {
        margin: 15px 0;
        line-height: 1.6;
        color: #333;
    }
    
    .mood-actions {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 8px 12px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #f8f9fa;
        color: #666;
    }
    
    .action-btn:hover {
        background: #e9ecef;
        transform: translateY(-1px);
    }
    
    .action-btn.liked {
        background: #ff4757;
        color: white;
    }
    
    .action-btn.comment-btn {
        background: #3742fa;
        color: white;
    }
    
    .comments-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        display: none;
    }
    
    .comments-section.show {
        display: block;
    }
    
    .comment-item {
        background: #f8f9fa;
        padding: 10px 15px;
        margin: 8px 0;
        border-radius: 8px;
        border-left: 3px solid #667eea;
    }
    
    .comment-form {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .comment-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
    }
    
    .comment-submit {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    .error {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #c62828;
    }
    
    .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #2e7d32;
    }
    
    .tab-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
    }
    
    .tab-btn {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    
    .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .privacy-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .privacy-public {
        background: #e8f5e8;
        color: #2e7d32;
    }
    
    .privacy-private {
        background: #fff3e0;
        color: #f57c00;
    }
    
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }
        
        .container {
            padding: 20px;
        }
        
        h1 {
            font-size: 1.8em;
        }
        
        .mood-section, .stats, .history-section {
            padding: 20px;
        }
        
        .score-display {
            font-size: 1.5em;
        }
        
        .history-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }
    
    @media (max-width: 480px) {
        .container {
            padding: 15px;
        }
        
        .mood-section, .stats, .history-section {
            padding: 15px;
        }
        
        .slider-labels {
            font-size: 14px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ˜Š ä»Šæ—¥å¼€å¿ƒæŒ‡æ•°æµ‹è¯„</h1>
    
    <div class="mood-section">
        <div class="slider-container">
            <div class="slider-labels">
                <div class="label-left">
                    <span>ğŸ˜¢</span>
                    <span>0åˆ† - å¿ƒæƒ…æŠ‘éƒ</span>
                </div>
                <div class="label-right">
                    <span>ğŸ˜„</span>
                    <span>10åˆ† - éå¸¸å¼€å¿ƒ</span>
                </div>
            </div>
            <input type="range" min="0" max="10" value="6" class="slider" id="score">
            <div class="score-display">
                å½“å‰åˆ†æ•°ï¼š<span id="scoreValue">6</span> åˆ†
            </div>
        </div>
        
        <textarea id="moodText" placeholder="æè¿°ä¸€ä¸‹ä½ çš„å¿ƒæƒ…å’Œæ„Ÿå—ï¼ˆå¯é€‰ï¼Œ100å­—ä»¥å†…ï¼‰"></textarea>
        
        <div class="privacy-toggle">
            <label>
                <input type="checkbox" id="isPublic" checked>
                <span>ğŸŒ å…¬å¼€åˆ†äº«ï¼ˆå…¶ä»–ç”¨æˆ·å¯ä»¥çœ‹åˆ°å¹¶äº’åŠ¨ï¼‰</span>
            </label>
            <small style="color: #666; margin-top: 5px; display: block;">å–æ¶ˆå‹¾é€‰åˆ™ä»…è‡ªå·±å¯è§</small>
        </div>
        
        <button onclick="submitMood()">ğŸ’¾ è®°å½•æˆ‘çš„å¿ƒæƒ…</button>
    </div>

    <div class="stats">
        <h3>ğŸ“Š ç¤¾åŒºç»Ÿè®¡æ•°æ®</h3>
        <div id="statsContent">
            <p>ğŸ“ˆ æ€»è®°å½•æ•°ï¼š<span id="total">0</span></p>
            <p>ğŸ‘¥ å…¬å¼€åˆ†äº«ï¼š<span id="publicMoods">0</span></p>
            <p>ğŸ“Š ç¤¾åŒºå¹³å‡åˆ†ï¼š<span id="average">0.0</span></p>
            <p>ğŸ‘ æ€»ç‚¹èµæ•°ï¼š<span id="totalLikes">0</span></p>
            <p>ğŸ’¬ æ€»è¯„è®ºæ•°ï¼š<span id="totalComments">0</span></p>
        </div>
    </div>
    
    <div class="community-section">
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('community')">ğŸŒ ç¤¾åŒºåŠ¨æ€</button>
            <button class="tab-btn" onclick="switchTab('personal')">ğŸ“ æˆ‘çš„è®°å½•</button>
        </div>
        
        <div id="communityTab" class="tab-content active">
            <div id="communityMoods"></div>
            <button id="loadMoreBtn" onclick="loadMoreMoods()" style="display: none;">åŠ è½½æ›´å¤š</button>
        </div>
        
        <div id="personalTab" class="tab-content">
            <div id="personalMoods"></div>
        </div>
    </div>
    
    <div class="history-section">
        <h3>âš™ï¸ æ•°æ®ç®¡ç†</h3>
        <p>ç®¡ç†æ‚¨çš„æ•°æ®å’Œéšç§è®¾ç½®ï¼š</p>
        <button class="clear-btn" onclick="clearPersonalHistory()">ğŸ—‘ï¸ æ¸…ç©ºä¸ªäººå†å²</button>
        <button class="clear-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
        <div id="messageArea"></div>
    </div>
</div>

<script>
// é…ç½®
const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';

// å…¨å±€å˜é‡
let currentUserId = localStorage.getItem('userId');
let currentPage = 1;
let isLoading = false;
let hasMoreData = true;

// åˆå§‹åŒ–ç”¨æˆ·ID
if (!currentUserId) {
    initializeUser();
}

// åˆå§‹åŒ–ç”¨æˆ·
async function initializeUser() {
    try {
        const response = await fetch(`${API_BASE}/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        currentUserId = data.userId;
        localStorage.setItem('userId', currentUserId);
    } catch (error) {
        console.error('åˆå§‹åŒ–ç”¨æˆ·å¤±è´¥:', error);
        // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
        currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', currentUserId);
    }
}

// æ»‘åŠ¨æ¡äº‹ä»¶
document.getElementById('score').oninput = function() {
    const value = this.value;
    document.getElementById('scoreValue').textContent = value;
    
    // æ ¹æ®åˆ†æ•°åŠ¨æ€æ”¹å˜æ»‘å—é¢œè‰²
    const percentage = (value / 10) * 100;
    if (value <= 3) {
        this.style.background = `linear-gradient(to right, #2196F3 0%, #2196F3 ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
    } else if (value <= 7) {
        this.style.background = `linear-gradient(to right, #2196F3 0%, #4CAF50 ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
    } else {
        this.style.background = `linear-gradient(to right, #2196F3 0%, #4CAF50 50%, #FF4444 ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
    }
};

// æäº¤å¿ƒæƒ…
async function submitMood() {
    const score = Number(document.getElementById('score').value);
    const text = document.getElementById('moodText').value.trim() || 'æ— å…·ä½“æè¿°';
    const isPublic = document.getElementById('isPublic').checked;
    
    if (!currentUserId) {
        await initializeUser();
    }
    
    try {
        const response = await fetch(`${API_BASE}/moods`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUserId,
                score: score,
                text: text,
                isPublic: isPublic
            })
        });
        
        if (response.ok) {
            showMessage('âœ… å¿ƒæƒ…è®°å½•æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„åˆ†äº«ã€‚', 'success');
            document.getElementById('moodText').value = '';
            
            // åˆ·æ–°æ•°æ®
            await loadStats();
            await loadCommunityMoods(true);
            await loadPersonalMoods();
        } else {
            throw new Error('æäº¤å¤±è´¥');
        }
    } catch (error) {
        console.error('æäº¤å¿ƒæƒ…å¤±è´¥:', error);
        showMessage('âŒ æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStats() {
    try {
        const response = await fetch(`${API_BASE}/stats`);
        const stats = await response.json();
        
        document.getElementById('total').textContent = stats.totalMoods || 0;
        document.getElementById('publicMoods').textContent = stats.publicMoods || 0;
        document.getElementById('average').textContent = (stats.avgScore || 0).toFixed(1);
        document.getElementById('totalLikes').textContent = stats.totalLikes || 0;
        document.getElementById('totalComments').textContent = stats.totalComments || 0;
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

// åŠ è½½ç¤¾åŒºå¿ƒæƒ…
async function loadCommunityMoods(reset = false) {
    if (isLoading) return;
    
    if (reset) {
        currentPage = 1;
        hasMoreData = true;
        document.getElementById('communityMoods').innerHTML = '';
    }
    
    if (!hasMoreData) return;
    
    isLoading = true;
    
    try {
        const response = await fetch(`${API_BASE}/moods/public?page=${currentPage}&limit=10`);
        const moods = await response.json();
        
        if (moods.length === 0) {
            hasMoreData = false;
            if (currentPage === 1) {
                document.getElementById('communityMoods').innerHTML = '<p class="loading">æš‚æ— å…¬å¼€åˆ†äº«ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«å¿ƒæƒ…çš„äººå§ï¼</p>';
            }
        } else {
            await renderMoods(moods, 'communityMoods', reset);
            currentPage++;
            
            if (moods.length < 10) {
                hasMoreData = false;
            }
        }
        
        document.getElementById('loadMoreBtn').style.display = hasMoreData ? 'block' : 'none';
    } catch (error) {
        console.error('åŠ è½½ç¤¾åŒºå¿ƒæƒ…å¤±è´¥:', error);
        showMessage('âŒ åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
    
    isLoading = false;
}

// åŠ è½½ä¸ªäººå¿ƒæƒ…
async function loadPersonalMoods() {
    try {
        const response = await fetch(`${API_BASE}/moods/user/${currentUserId}`);
        const moods = await response.json();
        
        if (moods.length === 0) {
            document.getElementById('personalMoods').innerHTML = '<p class="loading">æ‚¨è¿˜æ²¡æœ‰è®°å½•è¿‡å¿ƒæƒ…ï¼Œå¿«æ¥è®°å½•ç¬¬ä¸€æ¡å§ï¼</p>';
        } else {
            await renderMoods(moods, 'personalMoods', true, true);
        }
    } catch (error) {
        console.error('åŠ è½½ä¸ªäººå¿ƒæƒ…å¤±è´¥:', error);
    }
}

// æ¸²æŸ“å¿ƒæƒ…å¡ç‰‡
async function renderMoods(moods, containerId, reset = false, showPrivacy = false) {
    const container = document.getElementById(containerId);
    
    if (reset) {
        container.innerHTML = '';
    }
    
    for (const mood of moods) {
        const moodCard = document.createElement('div');
        moodCard.className = 'mood-card';
        moodCard.innerHTML = await generateMoodCardHTML(mood, showPrivacy);
        container.appendChild(moodCard);
    }
}

// ç”Ÿæˆå¿ƒæƒ…å¡ç‰‡HTML
async function generateMoodCardHTML(mood, showPrivacy = false) {
    const isLiked = await checkLikeStatus(mood.id);
    const privacyIndicator = showPrivacy ? 
        `<span class="privacy-indicator ${mood.is_public ? 'privacy-public' : 'privacy-private'}">
            ${mood.is_public ? 'ğŸŒ å…¬å¼€' : 'ğŸ”’ ç§å¯†'}
        </span>` : '';
    
    return `
        <div class="mood-header">
            <div class="mood-score">${mood.score}åˆ†</div>
            <div>
                ${privacyIndicator}
                <div class="mood-time">${new Date(mood.created_at).toLocaleString('zh-CN')}</div>
            </div>
        </div>
        <div class="mood-content">${mood.text}</div>
        <div class="mood-actions">
            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${mood.id}', this)">
                <span>${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                <span>${mood.like_count || 0}</span>
            </button>
            <button class="action-btn comment-btn" onclick="toggleComments('${mood.id}')">
                <span>ğŸ’¬</span>
                <span>${mood.comment_count || 0}</span>
            </button>
            ${showPrivacy ? `<button class="action-btn" onclick="togglePrivacy('${mood.id}', ${mood.is_public})">
                <span>${mood.is_public ? 'ğŸ”’' : 'ğŸŒ'}</span>
                <span>${mood.is_public ? 'è®¾ä¸ºç§å¯†' : 'è®¾ä¸ºå…¬å¼€'}</span>
            </button>` : ''}
        </div>
        <div class="comments-section" id="comments-${mood.id}">
            <div class="comment-form">
                <input type="text" class="comment-input" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." maxlength="200">
                <button class="comment-submit" onclick="addComment('${mood.id}', this)">å‘é€</button>
            </div>
            <div class="comments-list" id="comments-list-${mood.id}"></div>
        </div>
    `;
}

// æ£€æŸ¥ç‚¹èµçŠ¶æ€
async function checkLikeStatus(moodId) {
    try {
        const response = await fetch(`${API_BASE}/moods/${moodId}/like-status/${currentUserId}`);
        const data = await response.json();
        return data.liked;
    } catch (error) {
        return false;
    }
}

// åˆ‡æ¢ç‚¹èµ
async function toggleLike(moodId, button) {
    try {
        const response = await fetch(`${API_BASE}/moods/${moodId}/like`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUserId })
        });
        
        const data = await response.json();
        
        if (data.liked) {
            button.classList.add('liked');
            button.querySelector('span:first-child').textContent = 'â¤ï¸';
        } else {
            button.classList.remove('liked');
            button.querySelector('span:first-child').textContent = 'ğŸ¤';
        }
        
        // æ›´æ–°ç‚¹èµæ•°
        const currentCount = parseInt(button.querySelector('span:last-child').textContent);
        button.querySelector('span:last-child').textContent = data.liked ? currentCount + 1 : currentCount - 1;
        
    } catch (error) {
        console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
        showMessage('âŒ æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// åˆ‡æ¢è¯„è®ºåŒºæ˜¾ç¤º
async function toggleComments(moodId) {
    const commentsSection = document.getElementById(`comments-${moodId}`);
    
    if (commentsSection.classList.contains('show')) {
        commentsSection.classList.remove('show');
    } else {
        commentsSection.classList.add('show');
        await loadComments(moodId);
    }
}

// åŠ è½½è¯„è®º
async function loadComments(moodId) {
    try {
        const response = await fetch(`${API_BASE}/moods/${moodId}/comments`);
        const comments = await response.json();
        
        const commentsList = document.getElementById(`comments-list-${moodId}`);
        commentsList.innerHTML = comments.map(comment => `
            <div class="comment-item">
                <div>${comment.content}</div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    ${new Date(comment.created_at).toLocaleString('zh-CN')}
                </small>
            </div>
        `).join('');
    } catch (error) {
        console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
    }
}

// æ·»åŠ è¯„è®º
async function addComment(moodId, button) {
    const input = button.previousElementSibling;
    const content = input.value.trim();
    
    if (!content) {
        showMessage('âŒ è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/moods/${moodId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUserId,
                content: content
            })
        });
        
        if (response.ok) {
            input.value = '';
            await loadComments(moodId);
            
            // æ›´æ–°è¯„è®ºæ•°
            const commentBtn = button.closest('.mood-card').querySelector('.comment-btn span:last-child');
            const currentCount = parseInt(commentBtn.textContent);
            commentBtn.textContent = currentCount + 1;
        }
    } catch (error) {
        console.error('æ·»åŠ è¯„è®ºå¤±è´¥:', error);
        showMessage('âŒ è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// åˆ‡æ¢éšç§è®¾ç½®
async function togglePrivacy(moodId, currentIsPublic) {
    try {
        const response = await fetch(`${API_BASE}/moods/${moodId}/privacy`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUserId,
                isPublic: !currentIsPublic
            })
        });
        
        if (response.ok) {
            showMessage('âœ… éšç§è®¾ç½®å·²æ›´æ–°', 'success');
            await loadPersonalMoods();
            await loadCommunityMoods(true);
        }
    } catch (error) {
        console.error('æ›´æ–°éšç§è®¾ç½®å¤±è´¥:', error);
        showMessage('âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabName) {
    // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // æ›´æ–°å†…å®¹æ˜¾ç¤º
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // åŠ è½½å¯¹åº”æ•°æ®
    if (tabName === 'community') {
        loadCommunityMoods(true);
    } else if (tabName === 'personal') {
        loadPersonalMoods();
    }
}

// åŠ è½½æ›´å¤šå¿ƒæƒ…
function loadMoreMoods() {
    loadCommunityMoods(false);
}

// æ¸…ç©ºä¸ªäººå†å²
function clearPersonalHistory() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‚¨çš„ä¸ªäººå¿ƒæƒ…å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        // è¿™é‡Œå¯ä»¥è°ƒç”¨APIåˆ é™¤ä¸ªäººæ•°æ®
        showMessage('âœ… ä¸ªäººå†å²å·²æ¸…ç©º', 'success');
        loadPersonalMoods();
    }
}

// å¯¼å‡ºæ•°æ®
async function exportData() {
    try {
        const response = await fetch(`${API_BASE}/moods/user/${currentUserId}`);
        const data = await response.json();
        
        const exportData = {
            userId: currentUserId,
            exportTime: new Date().toISOString(),
            moods: data
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mood-data-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showMessage('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
    } catch (error) {
        console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
        showMessage('âŒ å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type) {
    const messageArea = document.getElementById('messageArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = type;
    messageDiv.textContent = message;
    messageArea.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.onload = async function() {
    // åˆå§‹åŒ–æ»‘åŠ¨æ¡é¢œè‰²
    document.getElementById('score').oninput();
    
    // åŠ è½½æ•°æ®
    await loadStats();
    await loadCommunityMoods(true);
};
</script>
</body>
</html>
