<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÂºÄÂøÉÊåáÊï∞Á§æÂå∫ - ÂåøÂêçÂøÉÊÉÖÂàÜ‰∫´Âπ≥Âè∞</title>
<style>
    * { box-sizing: border-box; }
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        max-width: 800px; 
        margin: 0 auto; 
        padding: 20px; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        line-height: 1.6;
    }
    
    .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
    }
    
    h1 { 
        text-align: center; 
        color: #333;
        margin-bottom: 40px;
        font-size: 2.2em;
        font-weight: 300;
    }
    
    .mood-section {
        margin-bottom: 40px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px solid #e9ecef;
    }
    
    .slider-container {
        margin: 30px 0;
        position: relative;
    }
    
    .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .label-left {
        color: #2196F3;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .label-right {
        color: #FF4444;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .slider {
        width: 100%;
        height: 12px;
        border-radius: 6px;
        background: linear-gradient(to right, #2196F3 0%, #4CAF50 50%, #FF4444 100%);
        outline: none;
        -webkit-appearance: none;
        margin: 20px 0;
    }
    
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 3px solid #333;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .slider::-moz-range-thumb {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: white;
        border: 3px solid #333;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .score-display {
        text-align: center;
        font-size: 2em;
        font-weight: bold;
        margin: 20px 0;
        padding: 15px;
        background: white;
        border-radius: 10px;
        border: 2px solid #ddd;
    }
    
    textarea { 
        width: 100%; 
        height: 100px; 
        margin-top: 15px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        resize: vertical;
        font-family: inherit;
    }
    
    textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button { 
        display: block; 
        margin: 25px auto; 
        padding: 15px 30px; 
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white; 
        border: none; 
        border-radius: 25px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .stats { 
        background: white; 
        padding: 25px; 
        margin-top: 30px; 
        border-radius: 15px;
        border: 2px solid #e9ecef;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .stats h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }
    
    .stats p {
        margin: 15px 0;
        font-size: 16px;
    }
    
    .mood-list { 
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .mood-item {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }
    
    .history-section {
        margin-top: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px solid #e9ecef;
    }
    
    .history-item {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        border-left: 4px solid #28a745;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .clear-btn {
        background: #dc3545;
        padding: 8px 16px;
        font-size: 14px;
        margin: 10px 5px;
    }
    
    .privacy-toggle {
        margin: 15px 0;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 10px;
        border: 2px solid #2196F3;
    }
    
    .privacy-toggle label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .privacy-toggle input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .community-section {
        margin-top: 30px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px solid #e9ecef;
    }
    
    .tab-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .tab-btn {
        flex: 1;
        padding: 12px 20px;
        background: #e9ecef;
        color: #666;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 0;
    }
    
    .tab-btn.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        transform: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .mood-card {
        background: white;
        padding: 20px;
        margin: 15px 0;
        border-radius: 15px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }
    
    .mood-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .mood-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .mood-score {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
    }
    
    .mood-time {
        color: #666;
        font-size: 0.9em;
    }
    
    .mood-content {
        margin: 15px 0;
        line-height: 1.6;
        color: #333;
    }
    
    .mood-actions {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
        margin: 0;
    }
    
    .action-btn:hover {
        background: #e9ecef;
        transform: translateY(-1px);
    }
    
    .action-btn.liked {
        background: #ffe6e6;
        border-color: #ff9999;
        color: #d63384;
    }
    
    .privacy-indicator {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        margin-right: 10px;
    }
    
    .privacy-public {
        background: #d4edda;
        color: #155724;
    }
    
    .privacy-private {
        background: #f8d7da;
        color: #721c24;
    }
    
    .comments-section {
        display: none;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .comments-section.show {
        display: block;
    }
    
    .comment-form {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .comment-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
    }
    
    .comment-submit {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        margin: 0;
    }
    
    .comment-item {
        background: #f8f9fa;
        padding: 10px 15px;
        margin: 8px 0;
        border-radius: 10px;
        border-left: 3px solid #667eea;
    }
    
    .loading {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 20px;
    }
    
    .success {
        background: #d4edda;
        color: #155724;
        padding: 10px 15px;
        border-radius: 5px;
        margin: 10px 0;
        border: 1px solid #c3e6cb;
    }
    
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 10px 15px;
        border-radius: 5px;
        margin: 10px 0;
        border: 1px solid #f5c6cb;
    }
    
    @media (max-width: 600px) {
        body { padding: 10px; }
        .container { padding: 20px; }
        h1 { font-size: 1.8em; }
        .mood-actions { flex-wrap: wrap; }
        .tab-container { flex-direction: column; }
    }
</style>
</head>
<body>
<div class="container">
    <h1>üåà ÂºÄÂøÉÊåáÊï∞Á§æÂå∫</h1>
    
    <div class="mood-section">
        <h3>üìù ËÆ∞ÂΩï‰Ω†ÁöÑÂøÉÊÉÖ</h3>
        <p>ÊãñÂä®ÊªëÂùóÈÄâÊã©‰Ω†ÂΩìÂâçÁöÑÂºÄÂøÉÁ®ãÂ∫¶Ôºö</p>
        
        <div class="slider-container">
            <div class="slider-labels">
                <div class="label-left">
                    <span>üò¢</span>
                    <span>Âæà‰∏çÂºÄÂøÉ</span>
                </div>
                <div class="label-right">
                    <span>üòä</span>
                    <span>ÈùûÂ∏∏ÂºÄÂøÉ</span>
                </div>
            </div>
            <input type="range" min="0" max="10" value="6" class="slider" id="score">
            <div class="score-display">
                ÂΩìÂâçÂàÜÊï∞Ôºö<span id="scoreValue">6</span> ÂàÜ
            </div>
        </div>
        
        <textarea id="moodText" placeholder="ÊèèËø∞‰∏Ä‰∏ã‰Ω†ÁöÑÂøÉÊÉÖÂíåÊÑüÂèóÔºàÂèØÈÄâÔºå100Â≠ó‰ª•ÂÜÖÔºâ"></textarea>
        
        <div class="privacy-toggle">
            <label>
                <input type="checkbox" id="isPublic" checked>
                <span>üåç ÂÖ¨ÂºÄÂàÜ‰∫´ÔºàÂÖ∂‰ªñÁî®Êà∑ÂèØ‰ª•ÁúãÂà∞Âπ∂‰∫íÂä®Ôºâ</span>
            </label>
            <small style="color: #666; margin-top: 5px; display: block;">ÂèñÊ∂àÂãæÈÄâÂàô‰ªÖËá™Â∑±ÂèØËßÅ</small>
        </div>
        
        <button onclick="submitMood()">üíæ ËÆ∞ÂΩïÊàëÁöÑÂøÉÊÉÖ</button>
    </div>

    <div class="stats">
        <h3>üìä Á§æÂå∫ÁªüËÆ°Êï∞ÊçÆ</h3>
        <div id="statsContent">
            <p>üìà ÊÄªËÆ∞ÂΩïÊï∞Ôºö<span id="total">0</span></p>
            <p>üë• ÂÖ¨ÂºÄÂàÜ‰∫´Ôºö<span id="publicMoods">0</span></p>
            <p>üìä Á§æÂå∫Âπ≥ÂùáÂàÜÔºö<span id="average">0.0</span></p>
            <p>üëç ÊÄªÁÇπËµûÊï∞Ôºö<span id="totalLikes">0</span></p>
            <p>üí¨ ÊÄªËØÑËÆ∫Êï∞Ôºö<span id="totalComments">0</span></p>
        </div>
    </div>
    
    <div class="community-section">
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('community')">üåç Á§æÂå∫Âä®ÊÄÅ</button>
            <button class="tab-btn" onclick="switchTab('personal')">üìù ÊàëÁöÑËÆ∞ÂΩï</button>
        </div>
        
        <div id="communityTab" class="tab-content active">
            <div id="communityMoods"></div>
            <button id="loadMoreBtn" onclick="loadMoreMoods()" style="display: none;">Âä†ËΩΩÊõ¥Â§ö</button>
        </div>
        
        <div id="personalTab" class="tab-content">
            <div id="personalMoods"></div>
        </div>
    </div>
    
    <div class="history-section">
        <h3>‚öôÔ∏è Êï∞ÊçÆÁÆ°ÁêÜ</h3>
        <p>ÁÆ°ÁêÜÊÇ®ÁöÑÊï∞ÊçÆÂíåÈöêÁßÅËÆæÁΩÆÔºö</p>
        <button class="clear-btn" onclick="clearPersonalHistory()">üóëÔ∏è Ê∏ÖÁ©∫‰∏™‰∫∫ÂéÜÂè≤</button>
        <button class="clear-btn" onclick="exportData()">üì§ ÂØºÂá∫Êï∞ÊçÆ</button>
        <div id="messageArea"></div>
    </div>
</div>

<script>
// Êú¨Âú∞Â≠òÂÇ®ÈîÆÂêç
const STORAGE_KEYS = {
    USER_ID: 'happy_index_user_id',
    MOODS: 'happy_index_moods',
    LIKES: 'happy_index_likes',
    COMMENTS: 'happy_index_comments'
};

// ÂÖ®Â±ÄÂèòÈáè
let currentUserId = localStorage.getItem(STORAGE_KEYS.USER_ID);
let currentPage = 1;
let moodsPerPage = 10;

// ÂàùÂßãÂåñÁî®Êà∑ID
if (!currentUserId) {
    currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem(STORAGE_KEYS.USER_ID, currentUserId);
}

// Êú¨Âú∞Â≠òÂÇ®Â∑•ÂÖ∑ÂáΩÊï∞
function getStorageData(key) {
    try {
        return JSON.parse(localStorage.getItem(key)) || [];
    } catch (error) {
        console.error('ËØªÂèñÊú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', error);
        return [];
    }
}

function setStorageData(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
        return true;
    } catch (error) {
        console.error('‰øùÂ≠òÊú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', error);
        return false;
    }
}

// ÁîüÊàêÂîØ‰∏ÄID
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// ÊªëÂä®Êù°‰∫ã‰ª∂
document.getElementById('score').oninput = function() {
    const value = this.value;
    document.getElementById('scoreValue').textContent = value;
    
    // Ê†πÊçÆÂàÜÊï∞Âä®ÊÄÅÊîπÂèòÊªëÂùóÈ¢úËâ≤
    const percentage = (value / 10) * 100;
    if (value <= 3) {
        this.style.background = `linear-gradient(to right, #2196F3 0%, #2196F3 ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
    } else if (value <= 7) {
        this.style.background = `linear-gradient(to right, #2196F3 0%, #4CAF50 ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
    } else {
        this.style.background = `linear-gradient(to right, #2196F3 0%, #4CAF50 50%, #FF4444 ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
    }
};

// Êèê‰∫§ÂøÉÊÉÖ
function submitMood() {
    const score = Number(document.getElementById('score').value);
    const text = document.getElementById('moodText').value.trim() || 'Êó†ÂÖ∑‰ΩìÊèèËø∞';
    const isPublic = document.getElementById('isPublic').checked;
    
    // ÂàõÂª∫ÂøÉÊÉÖËÆ∞ÂΩï
    const mood = {
        id: generateId(),
        userId: currentUserId,
        score: score,
        text: text,
        isPublic: isPublic,
        createdAt: new Date().toISOString(),
        likeCount: 0,
        commentCount: 0
    };
    
    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    moods.unshift(mood); // Ê∑ªÂä†Âà∞ÂºÄÂ§¥
    
    if (setStorageData(STORAGE_KEYS.MOODS, moods)) {
        showMessage('‚úÖ ÂøÉÊÉÖËÆ∞ÂΩïÊàêÂäüÔºÅÊÑüË∞¢ÊÇ®ÁöÑÂàÜ‰∫´„ÄÇ', 'success');
        document.getElementById('moodText').value = '';
        
        // Âà∑Êñ∞Êï∞ÊçÆ
        loadStats();
        loadCommunityMoods();
        loadPersonalMoods();
    } else {
        showMessage('‚ùå ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
    }
}

// Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
function loadStats() {
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    const likes = getStorageData(STORAGE_KEYS.LIKES);
    const comments = getStorageData(STORAGE_KEYS.COMMENTS);
    
    const publicMoods = moods.filter(mood => mood.isPublic);
    const totalScore = moods.reduce((sum, mood) => sum + mood.score, 0);
    const avgScore = moods.length > 0 ? (totalScore / moods.length) : 0;
    
    document.getElementById('total').textContent = moods.length;
    document.getElementById('publicMoods').textContent = publicMoods.length;
    document.getElementById('average').textContent = avgScore.toFixed(1);
    document.getElementById('totalLikes').textContent = likes.length;
    document.getElementById('totalComments').textContent = comments.length;
}

// Âä†ËΩΩÁ§æÂå∫ÂøÉÊÉÖ
function loadCommunityMoods() {
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    const publicMoods = moods.filter(mood => mood.isPublic)
                            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    const container = document.getElementById('communityMoods');
    
    if (publicMoods.length === 0) {
        container.innerHTML = '<p class="loading">ÊöÇÊó†ÂÖ¨ÂºÄÂàÜ‰∫´ÔºåÊàê‰∏∫Á¨¨‰∏Ä‰∏™ÂàÜ‰∫´ÂøÉÊÉÖÁöÑ‰∫∫ÂêßÔºÅ</p>';
        document.getElementById('loadMoreBtn').style.display = 'none';
        return;
    }
    
    // ÂàÜÈ°µÊòæÁ§∫
    const startIndex = 0;
    const endIndex = currentPage * moodsPerPage;
    const displayMoods = publicMoods.slice(startIndex, endIndex);
    
    renderMoods(displayMoods, 'communityMoods', false);
    
    // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÊõ¥Â§öÊåâÈíÆ
    const hasMore = endIndex < publicMoods.length;
    document.getElementById('loadMoreBtn').style.display = hasMore ? 'block' : 'none';
}

// Âä†ËΩΩ‰∏™‰∫∫ÂøÉÊÉÖ
function loadPersonalMoods() {
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    const personalMoods = moods.filter(mood => mood.userId === currentUserId)
                              .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    const container = document.getElementById('personalMoods');
    
    if (personalMoods.length === 0) {
        container.innerHTML = '<p class="loading">ÊÇ®ËøòÊ≤°ÊúâËÆ∞ÂΩïËøáÂøÉÊÉÖÔºåÂø´Êù•ËÆ∞ÂΩïÁ¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
        return;
    }
    
    renderMoods(personalMoods, 'personalMoods', true);
}

// Ê∏≤ÊüìÂøÉÊÉÖÂç°Áâá
function renderMoods(moods, containerId, showPrivacy = false) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    moods.forEach(mood => {
        const moodCard = document.createElement('div');
        moodCard.className = 'mood-card';
        moodCard.innerHTML = generateMoodCardHTML(mood, showPrivacy);
        container.appendChild(moodCard);
    });
}

// ÁîüÊàêÂøÉÊÉÖÂç°ÁâáHTML
function generateMoodCardHTML(mood, showPrivacy = false) {
    const isLiked = checkLikeStatus(mood.id);
    const privacyIndicator = showPrivacy ? 
        `<span class="privacy-indicator ${mood.isPublic ? 'privacy-public' : 'privacy-private'}">
            ${mood.isPublic ? 'üåç ÂÖ¨ÂºÄ' : 'üîí ÁßÅÂØÜ'}
        </span>` : '';
    
    return `
        <div class="mood-header">
            <div class="mood-score">${mood.score}ÂàÜ</div>
            <div>
                ${privacyIndicator}
                <div class="mood-time">${new Date(mood.createdAt).toLocaleString('zh-CN')}</div>
            </div>
        </div>
        <div class="mood-content">${mood.text}</div>
        <div class="mood-actions">
            <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${mood.id}', this)">
                <span>${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                <span>${mood.likeCount || 0}</span>
            </button>
            <button class="action-btn comment-btn" onclick="toggleComments('${mood.id}')">
                <span>üí¨</span>
                <span>${mood.commentCount || 0}</span>
            </button>
            ${showPrivacy ? `<button class="action-btn" onclick="togglePrivacy('${mood.id}', ${mood.isPublic})">
                <span>${mood.isPublic ? 'üîí' : 'üåç'}</span>
                <span>${mood.isPublic ? 'ËÆæ‰∏∫ÁßÅÂØÜ' : 'ËÆæ‰∏∫ÂÖ¨ÂºÄ'}</span>
            </button>` : ''}
        </div>
        <div class="comments-section" id="comments-${mood.id}">
            <div class="comment-form">
                <input type="text" class="comment-input" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..." maxlength="200">
                <button class="comment-submit" onclick="addComment('${mood.id}', this)">ÂèëÈÄÅ</button>
            </div>
            <div class="comments-list" id="comments-list-${mood.id}"></div>
        </div>
    `;
}

// Ê£ÄÊü•ÁÇπËµûÁä∂ÊÄÅ
function checkLikeStatus(moodId) {
    const likes = getStorageData(STORAGE_KEYS.LIKES);
    return likes.some(like => like.moodId === moodId && like.userId === currentUserId);
}

// ÂàáÊç¢ÁÇπËµû
function toggleLike(moodId, button) {
    const likes = getStorageData(STORAGE_KEYS.LIKES);
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    
    const existingLikeIndex = likes.findIndex(like => 
        like.moodId === moodId && like.userId === currentUserId
    );
    
    const moodIndex = moods.findIndex(mood => mood.id === moodId);
    if (moodIndex === -1) return;
    
    if (existingLikeIndex >= 0) {
        // ÂèñÊ∂àÁÇπËµû
        likes.splice(existingLikeIndex, 1);
        moods[moodIndex].likeCount = Math.max(0, (moods[moodIndex].likeCount || 0) - 1);
        
        button.classList.remove('liked');
        button.querySelector('span:first-child').textContent = 'ü§ç';
    } else {
        // Ê∑ªÂä†ÁÇπËµû
        likes.push({
            id: generateId(),
            moodId: moodId,
            userId: currentUserId,
            createdAt: new Date().toISOString()
        });
        moods[moodIndex].likeCount = (moods[moodIndex].likeCount || 0) + 1;
        
        button.classList.add('liked');
        button.querySelector('span:first-child').textContent = '‚ù§Ô∏è';
    }
    
    // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑÁÇπËµûÊï∞
    button.querySelector('span:last-child').textContent = moods[moodIndex].likeCount;
    
    // ‰øùÂ≠òÊï∞ÊçÆ
    setStorageData(STORAGE_KEYS.LIKES, likes);
    setStorageData(STORAGE_KEYS.MOODS, moods);
    loadStats();
}

// ÂàáÊç¢ËØÑËÆ∫Âå∫ÊòæÁ§∫
function toggleComments(moodId) {
    const commentsSection = document.getElementById(`comments-${moodId}`);
    
    if (commentsSection.classList.contains('show')) {
        commentsSection.classList.remove('show');
    } else {
        commentsSection.classList.add('show');
        loadComments(moodId);
    }
}

// Âä†ËΩΩËØÑËÆ∫
function loadComments(moodId) {
    const comments = getStorageData(STORAGE_KEYS.COMMENTS);
    const moodComments = comments.filter(comment => comment.moodId === moodId)
                                .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
    
    const commentsList = document.getElementById(`comments-list-${moodId}`);
    commentsList.innerHTML = moodComments.map(comment => `
        <div class="comment-item">
            <div>${comment.content}</div>
            <small style="color: #666; margin-top: 5px; display: block;">
                ${new Date(comment.createdAt).toLocaleString('zh-CN')}
            </small>
        </div>
    `).join('');
}

// Ê∑ªÂä†ËØÑËÆ∫
function addComment(moodId, button) {
    const input = button.previousElementSibling;
    const content = input.value.trim();
    
    if (!content) {
        showMessage('‚ùå ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ', 'error');
        return;
    }
    
    const comments = getStorageData(STORAGE_KEYS.COMMENTS);
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    
    // Ê∑ªÂä†ËØÑËÆ∫
    const comment = {
        id: generateId(),
        moodId: moodId,
        userId: currentUserId,
        content: content,
        createdAt: new Date().toISOString()
    };
    
    comments.push(comment);
    
    // Êõ¥Êñ∞ÂøÉÊÉÖÁöÑËØÑËÆ∫Êï∞
    const moodIndex = moods.findIndex(mood => mood.id === moodId);
    if (moodIndex >= 0) {
        moods[moodIndex].commentCount = (moods[moodIndex].commentCount || 0) + 1;
    }
    
    // ‰øùÂ≠òÊï∞ÊçÆ
    setStorageData(STORAGE_KEYS.COMMENTS, comments);
    setStorageData(STORAGE_KEYS.MOODS, moods);
    
    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
    input.value = '';
    loadComments(moodId);
    
    // Êõ¥Êñ∞ËØÑËÆ∫Êï∞ÊòæÁ§∫
    const commentBtn = button.closest('.mood-card').querySelector('.comment-btn span:last-child');
    if (commentBtn && moodIndex >= 0) {
        commentBtn.textContent = moods[moodIndex].commentCount;
    }
    
    loadStats();
}

// ÂàáÊç¢ÈöêÁßÅËÆæÁΩÆ
function togglePrivacy(moodId, currentIsPublic) {
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    const moodIndex = moods.findIndex(mood => mood.id === moodId && mood.userId === currentUserId);
    
    if (moodIndex >= 0) {
        moods[moodIndex].isPublic = !currentIsPublic;
        
        if (setStorageData(STORAGE_KEYS.MOODS, moods)) {
            showMessage('‚úÖ ÈöêÁßÅËÆæÁΩÆÂ∑≤Êõ¥Êñ∞', 'success');
            loadPersonalMoods();
            loadCommunityMoods();
            loadStats();
        } else {
            showMessage('‚ùå Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        }
    }
}

// ÂàáÊç¢Ê†áÁ≠æÈ°µ
function switchTab(tabName) {
    // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Êõ¥Êñ∞ÂÜÖÂÆπÊòæÁ§∫
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // ÈáçÁΩÆÂàÜÈ°µ
    currentPage = 1;
    
    // Âä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
    if (tabName === 'community') {
        loadCommunityMoods();
    } else if (tabName === 'personal') {
        loadPersonalMoods();
    }
}

// Âä†ËΩΩÊõ¥Â§öÂøÉÊÉÖ
function loadMoreMoods() {
    currentPage++;
    loadCommunityMoods();
}

// Ê∏ÖÁ©∫‰∏™‰∫∫ÂéÜÂè≤
function clearPersonalHistory() {
    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊÇ®ÁöÑ‰∏™‰∫∫ÂøÉÊÉÖÂéÜÂè≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) {
        const moods = getStorageData(STORAGE_KEYS.MOODS);
        const likes = getStorageData(STORAGE_KEYS.LIKES);
        const comments = getStorageData(STORAGE_KEYS.COMMENTS);
        
        // Âà†Èô§‰∏™‰∫∫ÂøÉÊÉÖËÆ∞ÂΩï
        const filteredMoods = moods.filter(mood => mood.userId !== currentUserId);
        
        // Âà†Èô§‰∏™‰∫∫ÁÇπËµûËÆ∞ÂΩï
        const filteredLikes = likes.filter(like => like.userId !== currentUserId);
        
        // Âà†Èô§‰∏™‰∫∫ËØÑËÆ∫ËÆ∞ÂΩï
        const filteredComments = comments.filter(comment => comment.userId !== currentUserId);
        
        // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ
        setStorageData(STORAGE_KEYS.MOODS, filteredMoods);
        setStorageData(STORAGE_KEYS.LIKES, filteredLikes);
        setStorageData(STORAGE_KEYS.COMMENTS, filteredComments);
        
        showMessage('‚úÖ ‰∏™‰∫∫ÂéÜÂè≤Â∑≤Ê∏ÖÁ©∫', 'success');
        loadPersonalMoods();
        loadCommunityMoods();
        loadStats();
    }
}

// ÂØºÂá∫Êï∞ÊçÆ
function exportData() {
    const moods = getStorageData(STORAGE_KEYS.MOODS);
    const likes = getStorageData(STORAGE_KEYS.LIKES);
    const comments = getStorageData(STORAGE_KEYS.COMMENTS);
    
    // Á≠õÈÄâ‰∏™‰∫∫Êï∞ÊçÆ
    const personalMoods = moods.filter(mood => mood.userId === currentUserId);
    const personalLikes = likes.filter(like => like.userId === currentUserId);
    const personalComments = comments.filter(comment => comment.userId === currentUserId);
    
    const exportData = {
        userId: currentUserId,
        exportTime: new Date().toISOString(),
        moods: personalMoods,
        likes: personalLikes,
        comments: personalComments,
        stats: {
            totalMoods: personalMoods.length,
            publicMoods: personalMoods.filter(mood => mood.isPublic).length,
            privateMoods: personalMoods.filter(mood => !mood.isPublic).length,
            totalLikes: personalLikes.length,
            totalComments: personalComments.length
        }
    };
    
    try {
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mood-data-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showMessage('‚úÖ Êï∞ÊçÆÂØºÂá∫ÊàêÂäü', 'success');
    } catch (error) {
        console.error('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
        showMessage('‚ùå ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
    }
}

// ÊòæÁ§∫Ê∂àÊÅØ
function showMessage(message, type) {
    const messageArea = document.getElementById('messageArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = type;
    messageDiv.textContent = message;
    messageArea.appendChild(messageDiv);
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 5000);
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
window.onload = function() {
    // ÂàùÂßãÂåñÊªëÂä®Êù°È¢úËâ≤
    document.getElementById('score').oninput();
    
    // Âä†ËΩΩÊï∞ÊçÆ
    loadStats();
    loadCommunityMoods();
};
</script>
</body>
</html>
